<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ORGAN DONATION</title>
    <meta name="description" content="Ela Admin - HTML5 Admin Template">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <base href="/">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lykmapipo/themify-icons@0.1.2/css/themify-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pixeden-stroke-7-icon@1.2.3/pe-icon-7-stroke/dist/pe-icon-7-stroke.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.0/css/flag-icon.min.css">
    <link rel="stylesheet" href="assets/css/cs-skin-elastic.css">
    <link rel="stylesheet" href="assets/css/lib/datatable/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/style.css">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>

</head>

<body>
	<div class="colorlib-loader"></div>

    <!-- Left Panel -->
    <aside id="left-panel" class="left-panel">
        <nav class="navbar navbar-expand-sm navbar-default">
            <div id="main-menu" class="main-menu collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="menu-title">Patient Options</li><!-- /.menu-title -->
                    <li class=" dropdown">
                        <a href="registerPatient.html" class="dropdown-toggle"  aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-wheelchair"></i>Register Patient</a>
                        <a href="viewPatientList.html" class="dropdown-toggle"  aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-indent"></i>View Patient List</a>
                    </li>

                    <li class="menu-title">Donor Options</li><!-- /.menu-title -->
                    <li class=" dropdown">
                        <a href="registerDonor.html" class="dropdown-toggle"  aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-medkit"></i>Register Donor</a>
                        <a href="viewDonorList.html" class="dropdown-toggle"  aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-outdent"></i>View Donor List</a>
                    </li>

                    <li class="menu-title">Completed Records</li><!-- /.menu-title -->
                    <li class=" dropdown">
                        <a href="pairedRecords.html" class="dropdown-toggle"  aria-haspopup="true" aria-expanded="false"> <i class="menu-icon fa fa-cogs"></i>View Paired Records</a>
                    </li>

                </ul>
            </div><!-- /.navbar-collapse -->
        </nav>
    </aside>
    <!-- /#left-panel -->
    <!-- Right Panel -->
    <div id="right-panel" class="right-panel">
        <div id="alertMessage" class="sufee-alert alert with-close alert-primary alert-dismissible fade show">
        </div>
        <!-- Header-->
        <header id="header" class="header">
            <div class="top-left">
                <div class="navbar-header">
                    <a class="navbar-brand" href="./"><img style="height: 40px;" src="images/logo-black.JPG" alt="Logo"></a>
                    <a class="navbar-brand hidden" href="./"><img src="images/logo-black.JPG" alt="Logo"></a>
                    <a id="menuToggle" class="menutoggle"><i class="fa fa-bars"></i></a>
                </div>
            </div>
        </header><!-- /header -->
        <!-- Header-->

        <div class="breadcrumbs">
            <div class="breadcrumbs-inner">
                <div class="row m-0">
                    <div class="col-sm-4">
                        <div class="page-header float-left">
                            <div class="page-title">
                                <h1>Patient Details</h1>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-8">
                        <div class="page-header float-right">
                            <div class="page-title">
                                <ol class="breadcrumb text-right">
                                    <li><a href="index.html">Dashboard</a></li>
                                    <li><a href="viewPatientList.html">Patient List</a></li>
                                    <li class="active">Patient Details</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <form method="POST" action="/register_patient" id="donor_form">
                <div class="card">
                    <div class="card-header">
                        <i class="mr-2 fa"></i>
                        <strong class="card-title">Personal Details</strong>
                    </div>
                    <div class="card-body">  
                        <div class="row form-group">
                            <div class="col-md-8">
                                <label for="fname">Name*</label>
                                <input disabled="" type="text" id="fname" name="fname" class="form-control" value="<%= document.name %>" required="">
                            </div>
                            <div class="col-md-4">
                                <label for="patientId">Patient Id*</label>
                                <input disabled="" type="text" id="patientId" name="patientId" class="form-control" value="<%= document.patientId %>" required="">
                            </div>
                        </div>
            
                        <div class="row form-group">
                            <div class="col-md-4">
                                <label for="age">Age (Completed)*</label>
                                <input disabled="" type="number" id="age" name="age" class="form-control" value="<%= document.age %>" required="">
                            </div>
                            <div class="col-md-4">
                                <label for="gender">Gender*</label>
                                <input disabled="" id="age" name="age" class="form-control" value="<%= document.gender %>" required="">
                            </div>
                            <div class="col-md-4">
                                <label for="age">Preferred Language*</label>
                                <input disabled="" type="text" id="language" name="language" class="form-control" value="<%= document.prefered_language %>" required="">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <i class="mr-2 fa"></i>
                        <strong class="card-title">Contact Details</strong>
                    </div>
                    <div class="card-body">
                        <div class="row form-group">
                            <div class="col-md-4">
                                <label for="email">Email</label>
                                <input disabled="" type="email" id="email" name="email" class="form-control" value="<%= document.email %>">
                            </div>
                            <div class="col-md-4">
                                <label for="phone">Phone Number*</label>
                                <input disabled="" type="number" id="phone" name="phone" class="form-control" required="" value="<%= document.phoneNo %>">
                            </div>
                            <div class="col-md-4">
                                <label for="emergencyContact">Emergency Contact Number*</label>
                                <input disabled="" type="number" id="emergencyContact" name="emergencyContact" class="form-control" required="" value="<%= document.emergencyPhoneNo %>">
                            </div>
                        </div>
            
                        <div class="row form-group">
                            <div class="col-md-12">
                                <label for="message">Address*</label>
                                <textarea disabled="" name="address" id="address" cols="30" rows="2" class="form-control" required=""><%= document.address %></textarea>
                            </div>
                        </div>                                          
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <i class="mr-2 fa"></i>
                        <strong class="card-title">Medical Details</strong>
                    </div>
                    <div class="card-body">
                        <div class="row form-group">
                            <div class="col-md-4">
                                <label for="medicalHistory">Medical History*</label>
                                <textarea disabled="" name="medicalHistory" id="medicalHistory" cols="30" rows="6" class="form-control" required=""><%= document.medicalHistory %></textarea>
                            </div>
                            <div class="col-md-4">
                                <label for="familyHistory">Family History*</label>
                                <textarea disabled="" name="familyHistory" id="familyHistory" cols="30" rows="6" class="form-control" required=""><%= document.familyHistory %></textarea>
                            </div>
                            <div class="col-md-4">
                                <label for="medications">Current Medication*</label>
                                <textarea disabled="" name="medications" id="medications" cols="30" rows="6" class="form-control" required=""><%= document.currentMedication %></textarea>
                            </div>
                        </div>
            
                        <div class="row form-group">
                            <div class="col-md-6">
                                <label for="physicianName">Primary Care Physician</label>
                                <input disabled="" type="text" name="physicianName" id="physicianName" value="<%= document.physicianName %>" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label for="physicianNameContact">Primary Care Physician Contact Number</label>
                                <input disabled="" type="number" name="physicianContact" id="physicianContact" value="<%= document.physicianContact %>" class="form-control">
                            </div>
                        </div>            
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <i class="mr-2 fa"></i>
                        <strong class="card-title">Medical Records</strong>
                    </div>
                    <div class="card-body">
                        <div class="row form-group">
                            <div class="col-md-3">
                                <label for="bloodGroup">BloodGroup*</label>
                                <input disabled="" name="physicianContact" id="physicianContact" value="<%= document.bloodGroup %>" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label for="scr">sCr*</label>
                                <input disabled="" type="number" id="scr" name="scr" class="form-control" value="<%= document.sCr %>" required="">
                            </div>
                            <div class="col-md-3">
                                <label for="egfr">eGFR*</label>
                                <input disabled="" type="number" id="egfr" name="egfr" class="form-control" value="<%= document.eGFR %>" required="">
                            </div>
                            <div class="col-md-3">
                                <label for="hba1c">HbA1c*</label>
                                <input disabled="" type="number" id="hba1c" name="hba1c" class="form-control" value="<%= document.HbA1c %>" required="">
                            </div>
                        </div>
            
                        <div class="row form-group">
                            <div class="col-md-12">
                                <label for="hospital">Hospital Location*</label>
                                <input disabled="" type="text" name="hospital" id="hospital" class="form-control" value="<%= document.hospital %>" required="">
                            </div>
                        </div>            
                    </div>
                </div>            
            </form>

            <div class="card" id="compatibleDonorList">
                <div class="card-header">
                    <strong class="card-title">Compatible Donors List </strong>
                </div>
                <div class="card-body">
                    <table id="bootstrap-data-table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Donor Id</th>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Address</th>
                                <th>Blood Group</th>
                                <th>Registered Date</th>
                                <th>Mark as selected</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card" id="pairedWithDonor" style="display: none;">
                <div class="card-header">
                    <strong class="card-title">Matched Donor Details : </strong>
                </div>
                <div class="card-body">
                    This patient is paired with : <span id="pairedDonorId"></span>
                </div>
            </div>

        </div><!-- .content -->
        <div class="clearfix"></div>
    </div><!-- /#right-panel -->

    <input type="hidden" id="patientDbId" value="<%= document._id %>">
    <pre style="display: none;" id="donersInfo"><%= document.donorsList %></pre>
	<input type="hidden" id="isPaired" value="<%= document.linkedWithId %>">
	<input type="hidden" id="linkedDonerUserId" value="<%= document.linkedWithUserId %>">

    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <!-- jQuery -->
	<script src="assets/js/jquery.min.js"></script>
	<!-- jQuery Easing -->
	<script src="assets/js/jquery.easing.1.3.js"></script>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-match-height@0.7.2/dist/jquery.matchHeight.min.js"></script>
    <script src="assets/js/main.js"></script>


    <script src="assets/js/lib/data-table/datatables.min.js"></script>
    <script src="assets/js/lib/data-table/dataTables.bootstrap.min.js"></script>
    <script src="assets/js/lib/data-table/dataTables.buttons.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.bootstrap.min.js"></script>
    <script src="assets/js/lib/data-table/jszip.min.js"></script>
    <script src="assets/js/lib/data-table/vfs_fonts.js"></script>
    <script src="assets/js/lib/data-table/buttons.html5.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.print.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.colVis.min.js"></script>
    
    <script defer>
        $(document).ready(function () {
            $(".alert").css("display", "none")
        });

        const alreadyPaired = document.getElementById("isPaired").value
        if(alreadyPaired == ""){
            const donersData = JSON.parse(document.getElementById("donersInfo").innerText)
            const patientDbId = document.getElementById("patientDbId").value
            donersData.forEach(data => {
                const tr = document.createElement('tr');

                const id = document.createElement('td');
                const anchor = document.createElement('a');
                anchor.setAttribute('href', `get_donor_details/${data["_id"]}`);
                anchor.textContent = data["donorId"];
                id.appendChild(anchor);
                tr.appendChild(id);
                
                const name = document.createElement('td');
                name.textContent = data["name"];
                tr.appendChild(name);
                                    
                const age = document.createElement('td');
                age.textContent = data["age"];
                tr.appendChild(age);
                
                const address = document.createElement('td');
                address.textContent = data["address"];
                tr.appendChild(address);

                const bloodGroup = document.createElement('td');
                bloodGroup.textContent = data["bloodGroup"];
                tr.appendChild(bloodGroup);

                const insertedDate = document.createElement('td');
                date = new Date(data["insertedDate"]);
                insertedDate.textContent = `${date.getDate()}-${date.getMonth()}-${date.getFullYear()}` 
                tr.appendChild(insertedDate);

                const pairedId = document.createElement('td');
                const pairedIdAnchor = document.createElement('a');
                pairedIdAnchor.setAttribute('href', `pair_donor/${patientDbId}/${data["_id"]}`);
                pairedIdAnchor.textContent = "Select";
                pairedIdAnchor.name = "link";
                pairedId.appendChild(pairedIdAnchor);
                tr.appendChild(pairedId);

                $("#tableBody").append(tr);
            });
            $('#bootstrap-data-table').DataTable({
                lengthMenu: [[10, 20, 50, -1], [10, 20, 50, "All"]],
            });
        } 
        else{
            const linkedDonerUserId = document.getElementById("linkedDonerUserId").value
            $("#compatibleDonorList").css("display", "none");
            $("#pairedWithDonor").css("display", "flex");
            $("#pairedDonorId").html(`<a href='/get_donor_details/${alreadyPaired}'>${linkedDonerUserId}</a>`);
            $("#pairedPatientId").html(linkedDonerUserId);
            $("#alreadyPairedDetail").html(`<h2>Patient already paired with donor id : <h2>`)
            $("#h1Title").text('Matched Donor Details :')
        }

        $('a[name="link"]').on('click', function(event) {
            event.preventDefault();
            $(".colorlib-loader").css("display", "block");
            $.ajax({
                method: "POST",
                url: `${this.pathname}`,
                success: function(data){
                    if (data.status == "success") {
                        linkedDonerUserId = document.querySelector(`a[href="get_donor_details/${data.linkedWith}"]`).innerText;
                        $("#compatibleDonorList").css("display", "none");
                        $("#pairedWithDonor").css("display", "flex");
                        $("#pairedDonorId").html(`<a href='/get_donor_details/${data.linkedWith}'>${linkedDonerUserId}</a>`);
                    }

                    $(".colorlib-loader").css("display", "none");
                    $("#alertMessage").text(data.msg);
                    $(".alert").css("display", "flex")
                    $('html, body').scrollTop(0);
                    
                    setTimeout(function(){
                        $(".alert").css("display", "none")
                    }, 7000);
                },
                error: function(e){
                    $(".colorlib-loader").css("display", "none");
                }
            })
        });
    </script>

</body>
</html>